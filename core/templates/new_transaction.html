{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-6">Nova TransaÃ§Ã£o</h1>

<form method="post" action="{% url 'criar_transacao' %}" onsubmit="return validarForm();" class="space-y-6">
  {% csrf_token %}

  <!-- Tipo de TransaÃ§Ã£o -->
  <div>
    <label class="block font-semibold mb-2">Tipo de TransaÃ§Ã£o</label>
    <input type="hidden" name="tipo" id="tipo">
    <div class="flex space-x-4">
      <button type="button" onclick="selectOption('tipo','receita', this)"
              class="tipo-btn flex-1 border p-3 rounded-md text-center hover:bg-green-50">
        ğŸ’° Receita
      </button>
      <button type="button" onclick="selectOption('tipo','gasto', this)"
              class="tipo-btn flex-1 border p-3 rounded-md text-center hover:bg-red-50">
        ğŸ’¸ Gasto
      </button>
    </div>
  </div>

  <!-- DescriÃ§Ã£o -->
  <div>
    <label class="block font-semibold mb-2">DescriÃ§Ã£o</label>
    <input type="text" name="descricao" class="w-full border rounded-md p-3">
  </div>

  <!-- Valor -->
  <div>
    <label class="block font-semibold mb-2">Valor *</label>
    <input type="text" name="valor" class="w-full border rounded-md p-3" required id="valorInput" value="R$ 0,00">
  </div>

  <script>
    const input = document.getElementById('valorInput');

    // FunÃ§Ã£o para formatar nÃºmero como moeda brasileira
    function formatarMoeda(valor) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valor);
    }

    // Evento de digitaÃ§Ã£o
    input.addEventListener('input', function (e) {
      let valor = e.target.value.replace(/\D/g, '');

      // Se o campo estiver vazio, volta para R$ 0,00
      if (!valor) {
        e.target.value = formatarMoeda(0);
        return;
      }

      valor = (parseInt(valor, 10) / 100).toFixed(2);
      e.target.value = formatarMoeda(valor);
    });

    // Impede digitaÃ§Ã£o de caracteres nÃ£o numÃ©ricos
    input.addEventListener('keypress', function (e) {
      const charCode = e.which ? e.which : e.keyCode;
      if (charCode < 48 || charCode > 57) {
        e.preventDefault();
      }
    });

    // Se o campo perder o foco e estiver vazio, volta para R$ 0,00
    input.addEventListener('blur', function (e) {
      if (!e.target.value.trim()) {
        e.target.value = formatarMoeda(0);
      }
    });
  </script>


  <!-- MÃ©todo de Pagamento (sÃ³ mostra se for gasto) -->
  <div id="metodo-pagamento" style="display:none;">
    <label class="block font-semibold mb-2">MÃ©todo de Pagamento</label>
    <input type="hidden" name="metodo_pagamento" id="metodo_pagamento">
    <div class="flex space-x-4">
      <button type="button" onclick="selectOption('metodo_pagamento','debito', this)"
              class="metodo-btn flex-1 border p-3 rounded-md text-center hover:bg-blue-50">DÃ©bito</button>
      <button type="button" onclick="selectOption('metodo_pagamento','credito', this)"
              class="metodo-btn flex-1 border p-3 rounded-md text-center hover:bg-purple-50">CrÃ©dito</button>
    </div>
  </div>

  <!-- CartÃ£o de CrÃ©dito (sÃ³ mostra se for crÃ©dito) -->
  <div id="cartao-credito" style="display:none;">
      <label class="block font-semibold mb-2">CartÃ£o de CrÃ©dito</label>
      <select name="cartao_credito" class="w-full border rounded-md p-3">
          <option value="">Selecione o cartÃ£o</option>
          {% for cartao in cartoes %}
          <option value="{{ cartao.id }}">{{ cartao.name }} (Fecha dia {{ cartao.closing_day }})</option>
          {% endfor %}
      </select>
  </div>

  <!-- Categoria -->
  <div>
    <label class="block font-semibold mb-2">Categoria *</label>
    <input type="hidden" name="categoria" id="categoria">
    <div class="grid grid-cols-3 gap-4" id="categoria-container">
      <!--Categoria de Gastos-->
      <button type="button" data-type="gasto" onclick="selectOption('categoria','alimentacao', this)" class="categoria-btn border p-3 rounded-md">ğŸ½ï¸ AlimentaÃ§Ã£o</button>
      <button type="button" data-type="gasto" onclick="selectOption('categoria','transporte', this)" class="categoria-btn border p-3 rounded-md">ğŸš— Transporte</button>
      <button type="button" data-type="gasto" onclick="selectOption('categoria','moradia', this)" class="categoria-btn border p-3 rounded-md">ğŸ  Moradia</button>
      <button type="button" data-type="gasto" onclick="selectOption('categoria','saude', this)" class="categoria-btn border p-3 rounded-md">â¤ï¸ SaÃºde</button>
      <button type="button" data-type="gasto" onclick="selectOption('categoria','educacao', this)" class="categoria-btn border p-3 rounded-md">ğŸ“š EducaÃ§Ã£o</button>
      <button type="button" data-type="gasto" onclick="selectOption('categoria','lazer', this)" class="categoria-btn border p-3 rounded-md">ğŸ‰ Lazer</button>
      <button type="button" data-type="gasto" onclick="selectOption('categoria','compras', this)" class="categoria-btn border p-3 rounded-md">ğŸ›ï¸ Compras</button>
      <button type="button" data-type="gasto" onclick="selectOption('categoria','contas', this)" class="categoria-btn border p-3 rounded-md">ğŸ§¾ Contas</button>
      <button type="button" data-type="gasto" onclick="selectOption('categoria','outros_gastos', this)" class="categoria-btn border p-3 rounded-md">â– Outros Gastos</button>

      <!--Categoria de Receitas-->
      <button type="button" data-type="receita" onclick="selectOption('categoria','salario', this)" class="categoria-btn border p-3 rounded-md">ğŸ’¼ SalÃ¡rio</button>
      <button type="button" data-type="receita" onclick="selectOption('categoria','bonus', this)" class="categoria-btn border p-3 rounded-md">ğŸ BÃ´nus</button>
      <button type="button" data-type="receita" onclick="selectOption('categoria','freelance', this)" class="categoria-btn border p-3 rounded-md">ğŸ’» Freelance</button>
      <button type="button" data-type="receita" onclick="selectOption('categoria','investimentos', this)" class="categoria-btn border p-3 rounded-md">ğŸ“ˆ Investimentos</button>
      <button type="button" data-type="receita" onclick="selectOption('categoria','vale_alimentacao', this)" class="categoria-btn border p-3 rounded-md">ğŸ½ï¸ Vale AlimentaÃ§Ã£o</button>
      <button type="button" data-type="receita" onclick="selectOption('categoria','outras_receitas', this)" class="categoria-btn border p-3 rounded-md">â• Outras Receitas</button>
    </div>
  </div>

  <!-- Data -->
  <div>
    <label class="block font-semibold mb-2">Data *</label>
    <input type="date" name="data" class="w-full border rounded-md p-3" required>
  </div>

  <div>
    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700">
      Salvar TransaÃ§Ã£o
    </button>
  </div>
</form>

<script>
  function selectOption(field, value, el) {
    document.getElementById(field).value = value;

    // limpa seleÃ§Ã£o visual do grupo
    let selector = '';
    if (field === 'tipo') selector = '.tipo-btn';
    if (field === 'metodo_pagamento') selector = '.metodo-btn';
    if (field === 'categoria') selector = '.categoria-btn';
    document.querySelectorAll(selector).forEach(btn => btn.classList.remove('bg-blue-200','ring-2','ring-blue-500'));

    // aplica destaque no selecionado
    el.classList.add('bg-blue-200','ring-2','ring-blue-500');

    // mostra/oculta mÃ©todo de pagamento conforme tipo
    if (field === 'tipo') {
      const mp = document.getElementById('metodo-pagamento');
      if (value === 'gasto') {
        mp.style.display = 'block';
      } else {
        mp.style.display = 'none';
        document.getElementById('metodo_pagamento').value = '';
        document.querySelectorAll('.metodo-btn').forEach(btn => btn.classList.remove('bg-blue-200','ring-2','ring-blue-500'));

        // Esconde cartÃ£o de crÃ©dito tambÃ©m se mudar para receita
        document.getElementById('cartao-credito').style.display = 'none';
        document.querySelector('select[name="cartao_credito"]').value = '';
      }

      // filtra categorias conforme tipo
      filtrarCategorias(value);
    }

    // MOSTRA/OCULTA CARTÃƒO DE CRÃ‰DITO CONFORME MÃ‰TODO DE PAGAMENTO
    if (field === 'metodo_pagamento') {
      const cartao = document.getElementById('cartao-credito');
      if (value === 'credito') {
        cartao.style.display = 'block';
      } else {
        cartao.style.display = 'none';
        document.querySelector('select[name="cartao_credito"]').value = '';
      }
    }
  }

  function filtrarCategorias(tipo) {
    const botoes = document.querySelectorAll("#categoria-container button");
    botoes.forEach(btn => {
      if (btn.getAttribute("data-type") === tipo) {
        btn.style.display = "block";
      } else {
        btn.style.display = "none";
      }
    });

    // limpa categoria selecionada se trocar o tipo
    document.getElementById('categoria').value = '';
    document.querySelectorAll('.categoria-btn').forEach(btn => btn.classList.remove('bg-blue-200','ring-2','ring-blue-500'));
  }

  function validarForm() {
    const tipo = document.getElementById('tipo').value;
    const cat  = document.getElementById('categoria').value;
    const met  = document.getElementById('metodo_pagamento').value;
    const cartao = document.querySelector('select[name="cartao_credito"]').value;

    if (!tipo) { alert('Selecione o tipo (Receita ou Gasto).'); return false; }
    if (!cat)  { alert('Selecione uma categoria.'); return false; }
    if (tipo === 'gasto' && !met) { alert('Selecione o mÃ©todo de pagamento.'); return false; }

    // ValidaÃ§Ã£o adicional para cartÃ£o de crÃ©dito
    if (met === 'credito' && !cartao) {
      alert('Selecione o cartÃ£o de crÃ©dito.');
      return false;
    }

    return true;
  }
</script>
{% endblock %}
